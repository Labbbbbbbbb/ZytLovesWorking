# 1. 环境配置（不包含YOLO环境）
1. 安装[.NET7.0](https://dotnet.microsoft.com/zh-cn/download/dotnet/7.0)，添加
2. 安装python库
```bash
pip3 install onnx
pip3 install onnxruntime
pip3 install onnxsim
pip3 install opencv-python
pip3 install Pillow
以下内容自行替换成下载的nncase、nncase-kpu包
pip3 install nncase-*.whl
pip3 install nncase_kpu-*.whl
```
3. 疑难解答
	1. 在转换模型时报错“ImportError: DLL load failed while importing \_nncase”
		1. [ImportError: DLL load failed while importing _nncase](https://github.com/kendryte/nncase/issues/451)
		2. 安装[libomp140.x86_64.zip](https://github.com/kendryte/nncase/files/7594453/libomp140.x86_64.zip)到System32文件夹
	2. 使用 `test_det_kmodel.py`报错 `RunTimeError`
		1. 添加python安装`nncase`的目录到环境变量PATH`*\Lib\site-packages`
		2. 添加dotnet的安装目录到环境变量PATH`C:\Program Files\dotnet\sdk\{你的版本}`、`C:\Program Files\dotnet`
		3. 重启终端
# 2. 模型训练
1. 按照教程使用yolo训练即可，注意，`imgsz`应当设定为32倍数，且该参数非常重要，在后面模型转换时会使用
2. `yolo detect train data=datasets/fruits_yolo.yaml model=yolov8n.pt epochs=300 imgsz=320`
3. `yolo detect train data=datasets/fruits_yolo.yaml model=yolov8n.pt epochs=300 imgsz=640`
# 3. 模型转换
1. 将`.pt`模型转换为`.onnx`模型，注意，指令中的imgsz应当与模型训练章节中的`imgsz`保持一致
2. `yolo export model=runs/detect/train/weights/best.pt format=onnx imgsz=320`
3. `yolo export model=runs/detect/train/weights/best.pt format=onnx imgsz=640`
# 4. ONNX模型验证
1. 关注`test_det_onnx.py`文件106-109行左右
2. 配置`model_path`模型地址、`image_path`图片地址、`input_width`输入给模型的图片宽度、`input_width`输入给模型的图片高度。
3. 注意：`input_width`输入给模型的图片宽度、`input_width`输入给模型的图片高度应当与训练时的`imgsz`保持一致
# 5. 模型转换
1. `python to_kmodel.py --target k230 --model ../../runs/detect/train/weights/best.onnx --dataset ../test --input_width 640 --input_height 640 --ptq_option 2
2. 注意：`--input_width`、`--input_width`应当与训练时的`imgsz`保持一致

| 参数名称         | 描述    | 说明                                                                        | 类型    |
| ------------ | ----- | ------------------------------------------------------------------------- | ----- |
| target       | 目标平台  | 可选项为k230/CPU，对应k230芯片；                                                    | str   |
| model        | 模型路径  | 待转换的ONNX模型路径；                                                             | str   |
| dataset      | 校准图片集 | 模型转换时使用的图片数据，在量化阶段使用                                                      | str   |
| input_width  | 输入宽度  | 模型输入的宽度                                                                   | int   |
| input_height | 输入高度  | 模型输入的高度                                                                   | int   |
| ptq_option   | 量化方式  | data和weights的量化方式，0为\[uint8,uint8\], 1为\[uint8,int16\], 2为\[int16,uint8\] | 0/1/2 |
# 6.Kmodel验证 
1. 关注`test_det_kmodel.py`文件106-109行左右
2. 配置`model_path`模型地址、`image_path`图片地址、`input_width`输入给模型的图片宽度、`input_width`输入给模型的图片高度。
3. 注意：`input_width`输入给模型的图片宽度、`input_width`输入给模型的图片高度最好与训练时的`imgsz`保持一致
4. 使用CPU硬推理，运行速度较慢，建议直接部署测试